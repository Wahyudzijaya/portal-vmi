<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sistem Informasi Laporan Kemajuan Siswa - Bimbel Gambar Villa Merah (Supabase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { box-sizing: border-box; }
    * { box-sizing: border-box; }
    .sidebar-active { background-color: #1e40af; color: white; }
    .fade-in { animation: fadeIn .25s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(8px);} to {opacity:1; transform:none;} }
    .modal-backdrop { background-color: rgba(0,0,0,.5); }
    .notification { position: fixed; top: 20px; right:20px; z-index:1000; padding:12px 20px; border-radius:8px; color:white; font-weight:600; }
    .success{ background:#10b981 } .error{ background:#ef4444 }
  </style>
</head>
<body class="bg-white">

<!-- ===== LOGIN PAGE ===== -->
<div id="loginPage" class="min-h-screen flex items-center justify-center p-6">
  <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
    <div class="text-center mb-4">
      <img src="https://www.villamerah.com/assets/images/logo/logo-2.png" alt="logo" class="mx-auto w-28"/>
      <h1 class="text-2xl font-bold text-red-600">Bimbel Gambar Villa Merah</h1>
      <p class="text-sm text-blue-600">Laporan Kemajuan Siswa</p>
    </div>
    <form id="loginForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium">Username</label>
        <input id="username" class="w-full px-3 py-2 border rounded" required />
      </div>
      <div>
        <label class="block text-sm font-medium">Password</label>
        <input id="password" type="password" class="w-full px-3 py-2 border rounded" required />
      </div>
      <button class="w-full py-2 bg-blue-600 text-white rounded" type="submit">Masuk</button>
    </form>
  </div>
</div>

<!-- ===== DASHBOARD ===== -->
<div id="dashboardPage" class="hidden min-h-screen">
  <header class="bg-white border-b fixed w-full z-20">
    <div class="flex items-center justify-between px-6 py-4">
      <div class="flex items-center gap-4">
        <img src="https://bimbelgambar.id/wp-content/uploads/2023/06/favicon-20200601113259.png" class="w-10 h-10" />
        <div>
          <h2 id="hdrName" class="text-lg font-bold text-red-600"></h2>
          <p id="hdrSub" class="text-sm text-gray-600"></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span id="hdrRole" class="text-sm text-gray-700"></span>
        <button id="logoutBtn" class="px-3 py-2 bg-red-600 text-white rounded">Keluar</button>
      </div>
    </div>
  </header>
  <div class="flex pt-20">
    <aside class="w-64 bg-gradient-to-b from-blue-700 to-blue-900 min-h-screen p-4 text-white fixed">
      <nav id="sidebarMenu" class="space-y-2"></nav>
    </aside>
    <main class="ml-64 flex-1 p-8">
      <div id="contentArea" class="fade-in"></div>
    </main>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
  <div class="absolute inset-0 modal-backdrop" onclick="closeModal()"></div>
  <div class="bg-white rounded-lg shadow-xl z-10 w-full max-w-3xl max-h-[90vh] overflow-auto p-6">
    <div class="flex justify-between items-center mb-4">
      <h3 id="modalTitle" class="text-xl font-bold"></h3>
      <button onclick="closeModal()" class="text-2xl">&times;</button>
    </div>
    <div id="modalContent"></div>
  </div>
</div>

<div id="notif" class="hidden notification"></div>

<script>
// -------------------------
// Supabase config (from user)
// -------------------------
const SUPABASE_URL = 'https://fuullsarjlnrmibuppsx.supabase.co';
const SUPABASE_ANON_KEY = 'iOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1dWxsc2Fyamxucm1pYnVwcHN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjUzMTMsImV4cCI6MjA3ODY0MTMxM30.ClaOAc5IN2updSGNV9v1EU4e_Vi87Tgm3yzlG0gULSs';

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// -------------------------
// Local in-memory structures (fallback while loading)
// -------------------------
let currentUser = null;
let studentsData = [];
let classes = [];
let scheduleData = [];
let activityScheduleData = [];
let regionalAdmins = [];
let skolastikTests = [];
let tkaTests = [];
let attendanceData = [];
let educationInfo = [];

// -------------------------
// Utils
// -------------------------
function showNotification(msg, type='success'){
  const n = document.getElementById('notif');
  n.textContent = msg; n.className = 'notification ' + (type==='success'? 'success':'error');
  n.classList.remove('hidden');
  setTimeout(()=> n.classList.add('hidden'), 3500);
}
function openModal(title, html){ document.getElementById('modalTitle').textContent = title; document.getElementById('modalContent').innerHTML = html; document.getElementById('modal').classList.remove('hidden'); }
function closeModal(){ document.getElementById('modal').classList.add('hidden'); }

// -------------------------
// AUTH & SESSION
// -------------------------
async function tryAutoLogin(){
  const saved = localStorage.getItem('currentUser');
  if(saved){
    currentUser = JSON.parse(saved);
    await prepareApp();
    showDashboard();
  }
}

document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value.trim();

  // check regional_admins first
  const { data: admins, error: aErr } = await supabase.from('regional_admins').select('*').eq('username', username).limit(1);
  if(aErr){ console.error(aErr); showNotification('Gagal koneksi Supabase','error'); return; }
  if(admins && admins.length>0 && admins[0].password === password){
    currentUser = { ...admins[0], role: admins[0].username==='superadmin' ? 'Super Admin' : 'Admin' };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    await prepareApp();
    showDashboard();
    return;
  }

  // check students
  const { data: studs, error: sErr } = await supabase.from('students').select('*').eq('username', username).limit(1);
  if(sErr){ console.error(sErr); showNotification('Gagal koneksi Supabase','error'); return; }
  if(studs && studs.length>0 && studs[0].password === password){
    currentUser = { ...studs[0], role: 'Siswa' };
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    await prepareApp();
    showDashboard();
    return;
  }

  showNotification('Username atau password salah','error');
});

document.getElementById('logoutBtn').addEventListener('click', ()=>{
  localStorage.removeItem('currentUser');
  currentUser = null;
  document.getElementById('dashboardPage').classList.add('hidden');
  document.getElementById('loginPage').classList.remove('hidden');
});

// -------------------------
// Data loading / seeding helpers
// -------------------------
async function fetchAll(){
  // fetch tables in parallel
  const [sRes, cRes, scRes, aRes, artRes, stRes, tRes, atRes] = await Promise.all([
    supabase.from('students').select('*'),
    supabase.from('classes').select('*'),
    supabase.from('schedule').select('*'),
    supabase.from('attendance').select('*'),
    supabase.from('artworks').select('*'),
    supabase.from('skolastik_tests').select('*'),
    supabase.from('tka_tests').select('*'),
    supabase.from('activity_schedule').select('*')
  ]).catch(err=>{ console.error(err); showNotification('Gagal mengambil data','error'); });

  // assign if present
  studentsData = sRes && sRes.data ? sRes.data : [];
  classes = cRes && cRes.data ? cRes.data : [];
  scheduleData = scRes && scRes.data ? scRes.data : [];
  attendanceData = aRes && aRes.data ? aRes.data : [];
  const artData = artRes && artRes.data ? artRes.data : [];
  skolastikTests = stRes && stRes.data ? stRes.data : [];
  tkaTests = tRes && tRes.data ? tRes.data : [];
  activityScheduleData = atRes && atRes.data ? atRes.data : [];

  // regional admins
  const ra = await supabase.from('regional_admins').select('*');
  regionalAdmins = ra && ra.data? ra.data: [];

  // basic educationInfo kept client-side preserved
  educationInfo = [
    { id:1, title:'Sistem Ujian SNBP 2026', content:'Informasi SNBP 2026', date:'2024-01-15' }
  ];
}

async function prepareApp(){
  await fetchAll();
  buildSidebar();
}

// -------------------------
// CRUD helpers
// -------------------------
async function insertStudent(obj){
  const { error } = await supabase.from('students').insert(obj);
  if(error) { console.error(error); showNotification('Gagal menambah siswa','error'); return false; }
  await fetchAll();
  return true;
}
async function updateStudent(id, obj){
  const { error } = await supabase.from('students').update(obj).eq('id', id);
  if(error){ console.error(error); showNotification('Gagal update siswa','error'); return false; }
  await fetchAll();
  return true;
}
async function deleteStudent(id){
  const { error } = await supabase.from('students').delete().eq('id', id);
  if(error){ console.error(error); showNotification('Gagal hapus siswa','error'); return false; }
  await fetchAll();
  return true;
}

// artworks (store base64 or data URL in image column)
async function addArtwork(obj){
  const { error } = await supabase.from('artworks').insert(obj);
  if(error){ console.error(error); showNotification('Gagal simpan karya','error'); return false; }
  await fetchAll();
  return true;
}

// generic simple upserts for schedule/activity/classes
async function insertTable(table, obj){
  const { error } = await supabase.from(table).insert(obj);
  if(error){ console.error(error); showNotification('Gagal simpan','error'); return false; }
  await fetchAll();
  return true;
}

// -------------------------
// UI - Sidebar & routing
// -------------------------
function buildSidebar(){
  const sidebar = document.getElementById('sidebarMenu');
  let items = [
    {id:'home',label:'Home',icon:'ðŸ '},
    {id:'artProgress',label:'Kemajuan Gambar',icon:'ðŸŽ¨'},
    {id:'skolastikProgress',label:'Kemajuan Tes Skolastik',icon:'ðŸ“Š'},
    {id:'tkaProgress',label:'Kemajuan TKA',icon:'ðŸ“ˆ'},
    {id:'schedule',label:'Jadwal Belajar',icon:'ðŸ“…'},
    {id:'activitySchedule',label:'Jadwal Kegiatan',icon:'ðŸ“†'},
    {id:'materials',label:'Materi Kelas',icon:'ðŸ“š'},
    {id:'educationInfo',label:'Informasi Pendidikan',icon:'ðŸ“°'}
  ];
  if(currentUser.role==='Admin'){
    items.push({id:'addStudent',label:'Tambah Siswa',icon:'ðŸ‘¤'});
    items.push({id:'manageClasses',label:'Kelola Kelas',icon:'ðŸ«'});
  }
  if(currentUser.role==='Super Admin'){
    items = [
      {id:'home',label:'Home',icon:'ðŸ '},
      {id:'manageAdmins',label:'Kelola Admin Regional',icon:'ðŸ›¡ï¸'},
      {id:'addStudent',label:'Tambah Siswa (Global)',icon:'ðŸ‘¤'},
      {id:'manageClasses',label:'Kelola Kelas (Global)',icon:'ðŸ«'},
      {id:'logActivity',label:'Log Activity',icon:'ðŸ“œ'}
    ];
  }

  sidebar.innerHTML = items.map(it=>`<button onclick="loadModule('${it.id}')" id="menu-${it.id}" class="w-full text-left px-4 py-2 rounded hover:bg-blue-800">${it.icon} <span class="ml-2">${it.label}</span></button>`).join('');
}

function setActiveMenu(id){ document.querySelectorAll('[id^="menu-"]').forEach(b=>b.classList.remove('sidebar-active')); const btn = document.getElementById('menu-'+id); if(btn) btn.classList.add('sidebar-active'); }

function loadModule(id){ setActiveMenu(id); switch(id){
  case 'home': loadHome(); break;
  case 'artProgress': loadArtProgress(); break;
  case 'skolastikProgress': loadSkolastikProgress(); break;
  case 'tkaProgress': loadTkaProgress(); break;
  case 'schedule': loadSchedule(); break;
  case 'activitySchedule': loadActivitySchedule(); break;
  case 'materials': loadMaterials(); break;
  case 'educationInfo': loadEducationInfo(); break;
  case 'addStudent': loadAddStudent(); break;
  case 'manageClasses': loadManageClasses(); break;
  case 'manageAdmins': loadManageAdmins(); break;
  case 'logActivity': loadLogActivity(); break;
}
}

// -------------------------
// MODULE RENDERS
// -------------------------
function showDashboard(){
  document.getElementById('loginPage').classList.add('hidden');
  document.getElementById('dashboardPage').classList.remove('hidden');
  document.getElementById('hdrName').textContent = currentUser.name || currentUser.username;
  document.getElementById('hdrSub').textContent = 'Laporan Kemajuan Siswa';
  document.getElementById('hdrRole').textContent = currentUser.role || '';
  loadModule('home');
}

function loadHome(){
  const content = document.getElementById('contentArea');
  if(currentUser.role==='Super Admin'){
    const totalStudents = studentsData.length;
    const topSchool = (()=>{ const sc={}; studentsData.forEach(s=>{ if(s.school) sc[s.school]=(sc[s.school]||0)+1;}); const e = Object.entries(sc).sort((a,b)=>b[1]-a[1])[0]; return e? e[0]:'-'; })();
    const seni = studentsData.filter(s=>/seni/i.test(s.class||'')).length;
    const ar = studentsData.filter(s=>/arsitek/i.test(s.class||'')).length;
    content.innerHTML = `
      <div class="p-6 bg-gradient-to-r from-blue-600 to-blue-800 rounded text-white mb-4">
        <h2 class="text-2xl font-bold">Selamat Datang, ${currentUser.name}</h2>
        <p>Dashboard Kontrol Pusat - Semua Regional</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="p-4 bg-white rounded shadow"> <h4>Total Siswa</h4><p class="text-2xl font-bold">${totalStudents}</p></div>
        <div class="p-4 bg-white rounded shadow"> <h4>Sekolah Terbanyak</h4><p class="text-xl font-bold">${topSchool}</p></div>
        <div class="p-4 bg-white rounded shadow"> <h4>Seni Rupa</h4><p class="text-2xl font-bold">${seni}</p></div>
        <div class="p-4 bg-white rounded shadow"> <h4>Arsitektur</h4><p class="text-2xl font-bold">${ar}</p></div>
      </div>
    `;
  } else if(currentUser.role==='Admin'){
    const regionStudents = studentsData.filter(s=>s.region===currentUser.region);
    const totalStudents = regionStudents.length;
    const topSchool = (()=>{ const sc={}; regionStudents.forEach(s=>{ if(s.school) sc[s.school]=(sc[s.school]||0)+1;}); const e = Object.entries(sc).sort((a,b)=>b[1]-a[1])[0]; return e? e[0]:'-'; })();
    content.innerHTML = `
      <div class="p-6 bg-gradient-to-r from-blue-600 to-blue-800 rounded text-white mb-4">
        <h2 class="text-2xl font-bold">Selamat Datang, ${currentUser.name}</h2>
        <p>${currentUser.region}</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="p-4 bg-white rounded shadow"> <h4>Total Siswa</h4><p class="text-2xl font-bold">${totalStudents}</p></div>
        <div class="p-4 bg-white rounded shadow"> <h4>Sekolah Terbanyak</h4><p class="text-xl font-bold">${topSchool}</p></div>
      </div>
    `;
  } else {
    // siswa
    const s = studentsData.find(x=> x.id===currentUser.id) || {};
    const totalArt = (studentsData.find(ss=>ss.id===currentUser.id)?.artworks || []).length || 0;
    content.innerHTML = `
      <div class="p-6 bg-gradient-to-r from-blue-600 to-blue-800 rounded text-white mb-4">
        <h2 class="text-2xl font-bold">Selamat Datang, ${currentUser.name}</h2>
        <p>Pantau terus perkembangan belajar Anda</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 bg-white rounded shadow"> <h4>Total Karya</h4><p class="text-3xl font-bold">${totalArt}</p></div>
        <div class="p-4 bg-white rounded shadow"> <h4>Kelas</h4><p class="text-3xl font-bold">${currentUser.class||'-'}</p></div>
        <div class="p-4 bg-white rounded shadow"> <h4>Sekolah</h4><p>${currentUser.school||'-'}</p></div>
      </div>
    `;
  }
}

function loadArtProgress(){
  const content = document.getElementById('contentArea');
  let rows = '';
  studentsData.forEach(s=>{
    rows += `<tr class="border-b"><td class="px-2 py-2">${s.id}</td><td class="px-2 py-2">${s.name}</td><td class="px-2 py-2">${s.class}</td><td class="px-2 py-2"><button onclick="viewArtworks(${s.id})" class="px-2 py-1 bg-blue-600 text-white rounded">Lihat Karya</button></td></tr>`;
  });
  content.innerHTML = `<div class="p-4 bg-white rounded shadow"><h3 class="font-bold mb-4">Daftar Siswa & Karya</h3><table class="w-full"><thead><tr class="bg-gray-100"><th class="px-2 py-2">ID</th><th>Nama</th><th>Kelas</th><th>Aksi</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}

function viewArtworks(student_id){
  const s = studentsData.find(x=>x.id===student_id);
  const arts = (s && s.artworks) || [];
  let html = `<h4 class=\"font-bold mb-3\">Karya ${s? s.name:'-'}</h4>`;
  if(arts.length===0) html += '<p>Tidak ada karya</p>';
  arts.forEach(a=>{ html += `<div class=\"mb-3 border rounded p-3\"><h5 class=\"font-semibold\">${a.title}</h5><p>${a.description}</p><p class=\"text-sm text-gray-500\">${a.date}</p></div>`; });
  openModal('Karya Siswa', html);
}

function loadSkolastikProgress(){
  const content = document.getElementById('contentArea');
  let rows = skolastikTests.map(t=>`<tr class="border-b"><td class="px-2 py-2">${t.id}</td><td>${t.subject}</td><td>${t.score}</td><td>${t.comment||''}</td></tr>`).join('');
  content.innerHTML = `<div class="p-4 bg-white rounded shadow"><h3 class="font-bold mb-4">Tes Skolastik</h3><table class="w-full"><thead class=\"bg-gray-100\"><tr><th>ID</th><th>Mata Pelajaran</th><th>Skor</th><th>Komentar</th></tr></thead><tbody>${rows}</tbody></table></div>`;
}
function loadTkaProgress(){ const content = document.getElementById('contentArea'); let rows = tkaTests.map(t=>`<tr class="border-b"><td class="px-2 py-2">${t.id}</td><td>${t.subject}</td><td>${t.score}</td><td>${t.comment||''}</td></tr>`).join(''); content.innerHTML = `<div class="p-4 bg-white rounded shadow"><h3 class="font-bold mb-4">TKA</h3><table class="w-full"><thead class=\"bg-gray-100\"><tr><th>ID</th><th>Mata Pelajaran</th><th>Skor</th><th>Komentar</th></tr></thead><tbody>${rows}</tbody></table></div>`; }

function loadSchedule(){ const content = document.getElementById('contentArea'); let rows = scheduleData.map(s=>`<tr class="border-b"><td class="px-2 py-2">${s.date}</td><td>${s.day}</td><td>${s.subject}</td><td>${s.region}</td></tr>`).join(''); content.innerHTML = `<div class="p-4 bg-white rounded shadow"><h3 class="font-bold mb-4">Jadwal Belajar</h3><table class="w-full"><thead class=\"bg-gray-100\"><tr><th>Tanggal</th><th>Hari</th><th>Mata Pelajaran</th><th>Region</th></tr></thead><tbody>${rows}</tbody></table></div>`; }

function loadActivitySchedule(){ const content = document.getElementById('contentArea'); let rows = activityScheduleData.map(a=>`<tr class="border-b"><td class="px-2 py-2">${a.date}</td><td>${a.name}</td><td>${a.goal}</td><td>${a.region}</td></tr>`).join(''); content.innerHTML = `<div class="p-4 bg-white rounded shadow"><h3 class="font-bold mb-4">Jadwal Kegiatan</h3><table class="w-full"><thead class=\"bg-gray-100\"><tr><th>Tanggal</th><th>Nama</th><th>Goal</th><th>Region</th></tr></thead><tbody>${rows}</tbody></table></div>`; }

function loadMaterials(){ const content = document.getElementById('contentArea'); content.innerHTML = `<div class=\"p-4 bg-white rounded shadow\"><h3 class=\"font-bold mb-4\">Materi Kelas</h3><p>Materi akan ditampilkan di sini.</p></div>`; }
function loadEducationInfo(){ const content = document.getElementById('contentArea'); let html = educationInfo.map(e=>`<div class=\"mb-3 p-3 border rounded\"><h4 class=\"font-semibold\">${e.title}</h4><p>${e.content}</p></div>`).join(''); content.innerHTML = `<div class=\"p-4 bg-white rounded shadow\">${html}</div>`; }

function loadAddStudent(){ const content = document.getElementById('contentArea'); content.innerHTML = `
  <div class=\"p-4 bg-white rounded shadow\"> 
    <h3 class=\"font-bold mb-4\">Tambah Siswa</h3>
    <form id=\"addStudentForm\" class=\"space-y-3\"> 
      <input id=\"s_name\" placeholder=\"Nama\" class=\"w-full border px-3 py-2 rounded\" required />
      <input id=\"s_username\" placeholder=\"Username\" class=\"w-full border px-3 py-2 rounded\" required />
      <input id=\"s_password\" placeholder=\"Password\" class=\"w-full border px-3 py-2 rounded\" required />
      <input id=\"s_class\" placeholder=\"Kelas\" class=\"w-full border px-3 py-2 rounded\" required />
      <input id=\"s_region\" placeholder=\"Region\" class=\"w-full border px-3 py-2 rounded\" required />
      <input id=\"s_school\" placeholder=\"Sekolah\" class=\"w-full border px-3 py-2 rounded\" required />
      <div class=\"flex gap-2\"><button type=\"submit\" class=\"px-4 py-2 bg-blue-600 text-white rounded\">Simpan</button></div>
    </form>
  </div>`;
  document.getElementById('addStudentForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
    const obj = { name: document.getElementById('s_name').value.trim(), username: document.getElementById('s_username').value.trim(), password: document.getElementById('s_password').value.trim(), class: document.getElementById('s_class').value.trim(), region: document.getElementById('s_region').value.trim(), school: document.getElementById('s_school').value.trim() };
    const ok = await insertStudent(obj);
    if(ok){ showNotification('Siswa ditambahkan'); loadModule('home'); }
  });
}

function loadManageClasses(){ const content = document.getElementById('contentArea'); let rows = classes.map(c=>`<tr class=\"border-b\"><td class=\"px-2 py-2\">${c.id}</td><td>${c.name}</td><td>${c.region}</td></tr>`).join(''); content.innerHTML = `<div class=\"p-4 bg-white rounded shadow\"><h3 class=\"font-bold mb-4\">Kelas</h3><table class=\"w-full\"><thead class=\"bg-gray-100\"><tr><th>ID</th><th>Nama</th><th>Region</th></tr></thead><tbody>${rows}</tbody></table><div class=\"mt-4\"><h4 class=\"font-semibold\">Tambah Kelas</h4><form id=\"addClassForm\" class=\"mt-2\"><input id=\"c_name\" placeholder=\"Nama kelas\" class=\"border px-3 py-2 rounded w-full\" required /><input id=\"c_region\" placeholder=\"Region\" class=\"border px-3 py-2 rounded w-full mt-2\" required /><button class=\"mt-2 px-4 py-2 bg-blue-600 text-white rounded\" type=\"submit\">Simpan</button></form></div></div>`;
  document.getElementById('addClassForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const obj={ name: document.getElementById('c_name').value.trim(), region: document.getElementById('c_region').value.trim(), description: '' }; const ok = await insertTable('classes', obj); if(ok){ showNotification('Kelas ditambahkan'); loadModule('manageClasses'); } }); }

function loadManageAdmins(){ const content = document.getElementById('contentArea'); if(currentUser.role!=='Super Admin'){ content.innerHTML = '<div class="p-4 text-red-600">Akses ditolak</div>'; return; } let rows = regionalAdmins.map(r=>`<tr class="border-b"><td class="px-2 py-2">${r.id}</td><td>${r.username}</td><td>${r.name}</td><td>${r.region}</td></tr>`).join(''); content.innerHTML = `<div class="p-4 bg-white rounded shadow"><h3 class="font-bold mb-4">Admin Regional</h3><table class="w-full"><thead class="bg-gray-100"><tr><th>ID</th><th>Username</th><th>Nama</th><th>Region</th></tr></thead><tbody>${rows}</tbody></table><div class="mt-4"><h4 class="font-semibold">Tambah Admin</h4><form id="addAdminForm" class="mt-2"><input id="a_username" placeholder="Username" class="border px-3 py-2 rounded w-full" required /><input id="a_password" placeholder="Password" class="border px-3 py-2 rounded w-full mt-2" required /><input id="a_name" placeholder="Nama" class="border px-3 py-2 rounded w-full mt-2" required /><input id="a_region" placeholder="Region" class="border px-3 py-2 rounded w-full mt-2" required /><button class="mt-2 px-4 py-2 bg-blue-600 text-white rounded" type="submit">Simpan</button></form></div></div>`;
  document.getElementById('addAdminForm').addEventListener('submit', async (e)=>{ e.preventDefault(); const obj={ username: document.getElementById('a_username').value.trim(), password: document.getElementById('a_password').value.trim(), name: document.getElementById('a_name').value.trim(), region: document.getElementById('a_region').value.trim() }; const { error } = await supabase.from('regional_admins').insert(obj); if(error){ console.error(error); showNotification('Gagal menambah admin','error'); } else { showNotification('Admin ditambahkan'); await fetchAll(); loadModule('manageAdmins'); } }); }

function loadLogActivity(){ const content = document.getElementById('contentArea'); content.innerHTML = `<div class='p-4 bg-white rounded shadow'><h3 class='font-bold'>Log Activity</h3><p>Log aktivitas tidak tersedia (local)</p></div>`; }

// -------------------------
// Initialization
// -------------------------
window.addEventListener('DOMContentLoaded', async ()=>{
  // try auto-login if session
  await tryAutoLogin();
  // if no session, keep at login
  // else prepareApp and show dashboard
});

</script>
</body>
</html>
